var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},Algorithm;!function(a){var b=function(){function a(a){var b=this;this._MaxId=-1,this.blocks=ko.observableArray(),this.transitions=ko.observableArray(),this.maxLevel=ko.observable(1),this.blockMinDistance=ko.observable(20),this.connectorsAreaWidth=ko.computed(function(){return b.maxLevel()*b.blockMinDistance()}),this.containerWidth=ko.observable(500),this.blockWidth=ko.computed(function(){return.6*(b.containerWidth()-b.connectorsAreaWidth())}),this.commentWidth=ko.computed(function(){return b.containerWidth()-b.blockWidth()-b.connectorsAreaWidth()}),this.currentBlock=ko.observable(),this.detailTemplate="algorithm-default-details-template",this.isEditMode=ko.observable(!1),this.allowEdit=!0,this._blockMappings=$.extend(!0,{},{id:"id",text:"text",comment:"comment",num:"num",state:"state",detailTemplate:"algorithm-default-details-template","new":function(a){return{id:a}},change:function(){},click:function(){},customEdit:function(){}},a.blockMappings),this.detailTemplate=this._blockMappings.detailTemplate,this._transitionMappings=$.extend(!0,{},{iid:"iid",exit1:"exit1",exit2:"exit2","new":function(){return{}},change:function(){}},a.transitionMappings),this.allowEdit=a.allowEdit!==!1,a.items.forEach(function(a){var c=new d(a,b._blockMappings);c.id()>b._MaxId&&(b._MaxId=c.id()),b.blocks.push(c)}),a.transitions.forEach(function(a){if(ko.unwrap(a[b._transitionMappings.exit1])&&b.transitions.push(new e(b.findBlock(ko.unwrap(a[b._transitionMappings.iid])),b.findBlock(ko.unwrap(a[b._transitionMappings.exit1])),a,b._transitionMappings)),ko.unwrap(a[b._transitionMappings.exit2])){var c=new e(b.findBlock(ko.unwrap(a[b._transitionMappings.iid])),b.findBlock(ko.unwrap(a[b._transitionMappings.exit2])),a,b._transitionMappings);c.label(b.noTitle),b.transitions.push(c)}}),this._sortBlocks(),this._updateLayout(),this.blocks.subscribe(function(a){a.forEach(function(a){return b._blockMappings.change(a.status,a.value)})},null,"arrayChange"),this.transitions.subscribe(function(a){a.forEach(function(a){return b._transitionMappings.change(a.status,a.value)})},null,"arrayChange"),this.isEditMode.subscribe(function(a){a||b._blockMappings.change("edit",b.currentBlock())})}return a.prototype._collectFollowingBlocks=function(a,b,c){var d=this;void 0===c&&(c=[]);var e=this.blocks().filter(b),f=c.concat(e);e.forEach(function(b){var e=0!==d._findTransitionsTo(b).filter(function(a){return-1!==c.indexOf(a.startBlock())}).length;-1!==a.indexOf(b)||e||(a.push(b),f.splice(f.indexOf(b),1),d._collectFollowingBlocks(a,function(a){return 0!==d._findTransitionsTo(a).filter(function(a){return a.startBlock()===b}).length},f))})},a.prototype._sortBlocks=function(){var a=this,b=[];this._collectFollowingBlocks(b,function(b){return 0===a._findTransitionsTo(b).length}),this.blocks(b)},a.prototype._findTransitionsFrom=function(a){return this.transitions().filter(function(b){return b.startBlock()===a})},a.prototype._findTransitionsTo=function(a){return this.transitions().filter(function(b){return b.endBlock()===a})},a.prototype._isFitToLayoutLine=function(a,b){var c=!0;return a.forEach(function(a){c&&(c=a.start>b.start?b.start+b.length<=a.start:a.start+a.length<=b.start)}),c},a.prototype._prepareTransitions=function(){var a=this,b=[],c=[];this.transitions().forEach(function(d){if(d.startBlock()===d.endBlock())c.push(d);else{d.level(1);var e=a.blocks().indexOf(d.startBlock()),f=a.blocks().indexOf(d.endBlock());f-e===1?d.type("direct"):(d.type("far"),f>e?(d.direction("down"),b.push({transition:d,start:e,length:f-e})):(d.direction("up"),b.push({transition:d,start:f,length:e-f})))}}),c.forEach(function(b){a.transitions.remove(b)}),b.sort(function(a,b){return a.length-b.length});for(var d=[];b.length>0;){var e=!1;d.forEach(function(c,d){if(!e&&a._isFitToLayoutLine(c,b[0])){var f=b.splice(0,1)[0];f.transition.level(d+1),c.push(f),e=!0}}),e||d.push([])}this.maxLevel(d.length+1)},a.prototype._updateLayout=function(){var a=this;this.blocks().reduce(function(b,c){var d=0===a._findTransitionsTo(c).length,e=0===a._findTransitionsFrom(c).length;return c.isTerminator(d||e),c.isCondition(0!==a._findTransitionsFrom(c).filter(function(b){return b.label()===a.noTitle}).length),c.posY(b),b+c.height()+a.blockMinDistance()},0),this._prepareTransitions()},Object.defineProperty(a.prototype,"model",{get:function(){var a={items:[],transitions:[]};return this.blocks().forEach(function(b){return a.items.push(b.item)}),this.transitions().forEach(function(b){return a.transitions.push(b.transition)}),a},enumerable:!0,configurable:!0}),a.prototype.findBlock=function(a){return this.blocks().filter(function(b){return b.id()===a})[0]},a.prototype.addBlock=function(a,b){var c=this;void 0===b&&(b=!1);var f=new d(this._blockMappings["new"](++this._MaxId),this._blockMappings);this.blocks.splice(this.blocks().indexOf(a)+(b?0:1),0,f),b?(this._findTransitionsTo(a).forEach(function(a){a.endBlock(f),c._transitionMappings.change("edit",a)}),this.transitions.push(new e(f,a,this._transitionMappings["new"](++this._MaxId),this._transitionMappings))):(this._findTransitionsFrom(a).forEach(function(a){a.startBlock(f),c._transitionMappings.change("edit",a)}),this.transitions.push(new e(a,f,this._transitionMappings["new"](++this._MaxId),this._transitionMappings))),this._updateLayout()},a.prototype.removeBlock=function(a){var b=this;this._findTransitionsTo(a).forEach(function(c){b._findTransitionsFrom(a).forEach(function(a){c.endBlock(a.endBlock()),b._transitionMappings.change("edit",c)})}),this._findTransitionsFrom(a).forEach(function(a){b.transitions.remove(a)}),this.blocks.remove(a),this._updateLayout()},a.prototype.editBlock=function(a){this.currentBlock(a),this._blockMappings.customEdit(a)||this.isEditMode(!this.isEditMode())},a.prototype.clickBlock=function(a){this._blockMappings.click(a)},a.prototype.updateTransition=function(a,b,c,d){void 0===d&&(d=!1);var f=this._findTransitionsFrom(a).filter(function(a){return a.label()===c});if(d){if(0===f.filter(function(a){return a.endBlock()===b}).length){var g=new e(a,b,this._transitionMappings["new"](++this._MaxId),this._transitionMappings);g.label(c),this.transitions.push(g)}}else if(0===f.length){var g=new e(a,b,this._transitionMappings["new"](++this._MaxId),this._transitionMappings);g.label(c),this.transitions.push(g)}else{f[0].endBlock(b),this._transitionMappings.change("edit",f[0]);for(var h=1;h<f.length;h++)this.transitions.remove(f[h])}this._updateLayout()},Object.defineProperty(a.prototype,"addBeforeTitle",{get:function(){return a.addBeforeTitle},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"addAfterTitle",{get:function(){return a.addAfterTitle},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"editTitle",{get:function(){return a.titleEdit},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"removeTitle",{get:function(){return a.titleRemove},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"connectTitle",{get:function(){return a.connectTitle},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"yesTitle",{get:function(){return a.yesTitle},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"noTitle",{get:function(){return a.noTitle},enumerable:!0,configurable:!0}),a.yesTitle="yes",a.noTitle="no",a.addBeforeTitle="Add block before",a.addAfterTitle="Add block after",a.titleEdit="Edit block",a.titleRemove="Remove block",a.connectTitle="Drag to connect to...",a.closeTitle="Close",a}();a.AlgorithmViewModel=b;var c=function(){function a(a,b){var c=this;this._mappings=$.extend({},b),this._item=a,$.each(this._mappings,function(a,b){var d="_"+a;c[d]=ko.isObservable(c._item[b])?c._item[b]:ko.observable(c._item[b]),c[a]=ko.computed({read:function(){return c[d]()},write:function(a){c[d](a),ko.isObservable(c._item[b])||(c._item[b]=a)}})})}return Object.defineProperty(a.prototype,"item",{get:function(){return this._item},enumerable:!0,configurable:!0}),a}();a.ItemHolder=c;var d=function(a){function b(b,c){var d=this;a.call(this,b,c||{id:"id",text:"text",comment:"comment",num:"num",state:"state"}),this.isTerminator=ko.observable(!1),this.isCondition=ko.observable(!1),this.template=ko.computed(function(){return d.isCondition()?"algorithm-block-condition-template":"algorithm-block-item-template"}),this.height=ko.observable(50),this.posY=ko.observable(0)}return __extends(b,a),b}(c);a.AlgorithmItemBlockModel=d;var e=function(a){function c(b,c,d,e){var f=this;a.call(this,d,e||{iid:"iid",exit1:"exit1",exit2:"exit2"}),this.startBlock=ko.observable(),this.endBlock=ko.observable(),this.type=ko.observable("direct"),this.direction=ko.observable("down"),this.level=ko.observable(1),this.label=ko.observable(),this.template=ko.computed(function(){return"direct"!==f.type()?"down"===f.direction()?"algorithm-tr-far-down-template":"algorithm-tr-far-up-template":"algorithm-tr-direct-template"}),this.startBlock(b),this.endBlock(c)}return __extends(c,a),Object.defineProperty(c.prototype,"transition",{get:function(){return this.label()!==b.noTitle?{iid:this.startBlock().id(),exit1:this.endBlock().id(),exit2:void 0}:{iid:this.startBlock().id(),exit1:void 0,exit2:this.endBlock().id()}},enumerable:!0,configurable:!0}),c}(c);a.AlgorithmTransition=e}(Algorithm||(Algorithm={}));var Algorithm;!function(a){ko.bindingHandlers.algorithm={init:function(b,c,d,e,f){var g,h=ko.unwrap(c()),i=$("#algorithm-view-template"),j=(ko.observable(500),ko.observable(new a.AlgorithmViewModel(ko.unwrap(h.value)))),k=f.createChildContext(j);ko.isSubscribable(h.value)&&(g=h.value.subscribe(function(b){return j(new a.AlgorithmViewModel(b))})),$(b).children().remove(),$(b).append($(i.text())),ko.applyBindingsToDescendants(k,b);var l=setInterval(function(){j().containerWidth($(b).find(".algorithm-view-holder").width())},500);return ko.utils.domNodeDisposal.addDisposeCallback(b,function(){clearInterval(l),g&&g.dispose()}),{controlsDescendantBindings:!0}},update:function(){}},ko.bindingHandlers.algodetails={init:function(a,b,c,d,e){var f=ko.unwrap(b()),g=$(a),h=$("#algorithm-details-template"),i=e.createChildContext(f);$(a).children().remove(),$(a).append($(h.text()));var j=f.isEditMode.subscribe(function(a){var b={top:f.currentBlock().posY()+"px",left:f.connectorsAreaWidth()+"px",height:f.currentBlock().height()+"px",width:f.blockWidth()+"px"};a?(g.css(b),g.show(),g.animate({top:"-="+(f.currentBlock().posY()>200?200:f.currentBlock().posY())+"px",left:"0",height:"+=400px",width:"100%"})):g.animate(b,{complete:function(){g.hide()}})});return ko.utils.domNodeDisposal.addDisposeCallback(a,function(){j.dispose()}),ko.applyBindingsToDescendants(i,a),{controlsDescendantBindings:!0}}},ko.bindingHandlers.draggableblocks={init:function(b,c){var d=ko.unwrap(c()),e=$(b),f={dragstart:function(b){var c=b.originalEvent,d=ko.dataFor(c.target);if(d instanceof a.AlgorithmItemBlockModel){var e=$(b.target).attr("data-transition");return c.dataTransfer.effectAllowed="link",c.dataTransfer.setData("text",JSON.stringify({type:"AlgorithmItemBlockModel",id:d.id(),transitionType:e})),!0}},dragover:function(b){ko.dataFor(b.target)instanceof a.AlgorithmItemBlockModel&&b.preventDefault()},drop:function(b){var c=b.originalEvent,e=ko.dataFor(c.target);if(e instanceof a.AlgorithmItemBlockModel){var f=c.dataTransfer.getData("text");try{var g=JSON.parse(f);if("AlgorithmItemBlockModel"===g.type){var h=d.findBlock(g.id);h&&e&&(d.updateTransition(h,e,g.transitionType,b.ctrlKey),b.stopPropagation())}}catch(i){}}}};e.bind(f)}}}(Algorithm||(Algorithm={}));